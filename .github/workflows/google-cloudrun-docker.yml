# Este flujo de trabajo construye y sube un contenedor Docker a Google Artifact Registry
# y lo despliega en Cloud Run cuando se hace un commit a la rama "main".
name: 'Build and Deploy to Cloud Run'

on:
  push:
    branches:
      - 'main' # Asegúrate de que esta sea tu rama principal (puede ser 'master')

env:
  # ------------------ VALORES A COMPLETAR ------------------
  # Reemplaza 'nombre-de-tu-servicio' con el nombre que quieres para tu servicio en Cloud Run
  SERVICE: 'api-restaurante'
  # Reemplaza 'mi-pool-de-identidades' y 'mi-proveedor' con los nombres de tu configuración de Workload Identity
  WORKLOAD_IDENTITY_PROVIDER: 'projects/27263349264/locations/global/workloadIdentityPools/mi-pool-de-identidades/providers/mi-proveedor'
  # ---------------------------------------------------------

  PROJECT_ID: 'protean-iridium-481315-f9'
  REGION: 'europe-west1' # Región donde se desplegará tu servicio y donde está tu Artifact Registry

jobs:
  deploy:
    runs-on: 'ubuntu-latest'
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - name: 'Checkout'
        uses: 'actions/checkout@v4'

      # Paso 1: Autenticar con Google Cloud usando Workload Identity Federation
      - id: 'auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: '${{ env.WORKLOAD_IDENTITY_PROVIDER }}'
          # Asigna el rol 'Service Account User' a la cuenta de servicio que usará GitHub Actions
          service_account: 'github-actions-sa@${{ env.PROJECT_ID }}.iam.gserviceaccount.com' # TODO: Reemplaza con tu cuenta de servicio si es diferente

      # Paso 2: Autenticar Docker con Artifact Registry
      - name: 'Docker Auth'
        uses: 'docker/login-action@v3'
        with:
          username: 'oauth2accesstoken'
          password: '${{ steps.auth.outputs.access_token }}'
          registry: '${{ env.REGION }}-docker.pkg.dev'

      # Paso 3: Construir y subir la imagen del contenedor
      # El nombre de la imagen será: tu-region-docker.pkg.dev/tu-proyecto/tu-servicio:hash-del-commit
      - name: 'Build and Push Container'
        run: |-
          docker build --tag "${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.SERVICE }}/${{ env.SERVICE }}:${{ github.sha }}" .
          docker push "${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.SERVICE }}/${{ env.SERVICE }}:${{ github.sha }}"

      # Paso 4: Desplegar la imagen en Cloud Run
      - name: 'Deploy to Cloud Run'
        uses: 'google-github-actions/deploy-cloudrun@v2'
        with:
          service: '${{ env.SERVICE }}'
          region: '${{ env.REGION }}'
          image: '${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.SERVICE }}/${{ env.SERVICE }}:${{ github.sha }}'
          # Descomenta la siguiente línea si quieres que tu servicio sea público
          # flags: '--allow-unauthenticated'

      # (Opcional) Muestra la URL del servicio desplegado
      - name: 'Show output'
        run: 'echo "Servicio desplegado en: ${{ steps.deploy.outputs.url }}"'

